# 00. 网络协议介绍



## 基础
### TCP/IP 网络模型

应用层: 应用软件所在层级，协议丰富HTTP/HTTP、FTP、RPC、SMTP...... 数据包：报文

运输层: TCP、UDP协议，封装 TCP报文段(segmenet) 或者 UDP用户数据报(datagram)

网络层：IP 协议，封装 IP数据报或者分组(packet)

链路层: 以太网协议，封装 MAC 帧(frame)

物理层: 比特流 (bit stream)

### 网络数据包传递流程
以浏览器访问网页为例子，说明网络数据的传输流程：
首先，在浏览器地址栏输入 `www.baidu.com`，
1. 因为输入的地址可能不是完整的，浏览器进行解析，并尽可能的进行自动补全: `https://www.baidu.com/`；比如给朋友打电话时，一般不会在号码前加上`86`, 会有手机拨号应用自动补全 `86`；
2. 互联网设置之间的通讯是必须要知道对方的IP地址的，通过`URL`找到对方的`IP`地址这一过程，就是DNS解析；比如给朋友打电话，只会在通讯录中找到朋友名字，而不会去找他的号码；
3. 通过DNS解析最终会得到这个地址：`36.155.132.3`。这个是百度服务器所在的IP地址；
4. 浏览器使用 `HTTP/HTTPS` 协议，封装一个 `Request`请求，传递给 `运输层`;
    ```text
    MESSAGE:
    HTTP  -------------------------
        | POST, URL, HTTP 1.1   |  
        | 格式:JSON，长度:1111   |
        -------------------------
        |   （携带一些数据）      |
        -------------------------
    ```
5. 运输层主要有两种协议： UDP和TCP， 对上层的报文进行一层封装，加上本地应用的端口和目标服务器的端口，然后交给 `网络层`;
    ```text
    SEGMENT:
    TCP  -------------------------
        | 浏览器端口: 19000      |  
        | 百度端口： 443         |
    HTTP  -------------------------
        | POST, URL, HTTP 1.1   |  
        | 格式:JSON，长度:1111   |
        -------------------------
        | 你要搜索什么?          |
        -------------------------
    ```
6. 网络层主要使用的是 IP 协议， 对上层的报文进行一层封装，加上源IP地址和目标IP地址，然后交给 `链路层`;
    ```text
    PACKET:
    IP   -------------------------
        | 本机IP地址: 192.168.1.100 |  
        | 百度IP地址： 172.16.17.32 |
    TCP  -------------------------
        | 浏览器端口: 19000      |  
        | 百度端口： 443         |
    HTTP  -------------------------
        | POST, URL, HTTP 1.1   |  
        | 格式:JSON，长度:1111   |
        -------------------------
        | 你要搜索什么?          |
        -------------------------
    ```
7. 链路层再次封装成帧，加上源MAC地址和目标MAC地址，然后发送出去；
    ```text
    FRAME:
    MAC  -------------------------
        | 本机MAC:  xxx.xxx.xxx.xxx |  
        | 网关MAC： xxx.xxx.xxx.xxx |
    IP   -------------------------
        | 本机IP地址: 192.168.1.100 |  
        | 百度IP地址： 172.16.17.32 |
    TCP  -------------------------
        | 浏览器端口: 19000      |  
        | 百度端口： 443         |
    HTTP  -------------------------
        | POST, URL, HTTP 1.1   |  
        | 格式:JSON，长度:1111   |
        -------------------------
        | 你要搜索什么?          |
        -------------------------
    ```
8. 数据包在发送出去后，通过一个又一个的路由（通过比较 MAC 地址），最终到达指定服务器；
9.  百度的服务器链路层获取到，反向一层层的解包，最后到达应用层的服务进程，服务进程解析 `Request` 请求，将对应的资源数据，以同样的方式返回给浏览器;
10. 浏览器收到响应数据，解析，并显示在页面上。

## TCP 协议

1. 面向有连接的通信协议；
2. TCP全程传输控制协议(Transmission Control Protocol), 提供了负责的控制机制，目的就是为了保证数据传输的可靠性；

### 如何保证可靠性

#### 差错控制
监测损坏、丢失、失序的报文段，并进行纠正，保证整个数据流能按序，无损坏、无丢失、无重复的传输到目的地。


使用的方法手段有：`校验和`、`确认应答`、`重传` 三种；

- 校验和
  
    `TCP` 首部中有`校验和`字段，`校验和`字段的作用是检测数据是否出现错误，`校验和`字段的计算方法是将整个报文段的首部和数据部分进行计算，然后取反，并将结果的低 16 位作为校验和字段的值。当接收方收到报文段后，会重新计算校验和，并与接收到的校验和进行比较，如果相同，则说明数据没有出现错误，否则说明数据出现错误，需要丢弃该报文段。

- 确认应答
  
    `TCP` 协议中，每发送一个报文段，都需要对前一个报文段进行确认，以保证接收方能正确接收到数据。最经典的就是三次握手。
    客户端发起 请求建立连接(SYN)；
    服务端收到后，回复一个 `SYN&#43;ACK` 包，表示建立连接请求被接收，并要求客户端发送 `ACK` 包，表示同意建立连接；
    客户端收到 `SYN&#43;ACK` 包后，也发送一个 `ACK` 包，表示同意建立连接；

    如果服务端收到了`ACK`，说明数据已经成功的到达了对端，反之，数据就很有可能丢失了，这时候就需要重传。

- 重传

    有两种机制：`超时重传`和`快重传`。

    超时重传，好理解，就是发出数据包后，在 `特定时间间隔` 内还没有收到 `ACK`, 就会触发超时重传，包含两种可能的情况：

    (a) 发送数据过程中，由于拥堵导致超时，导致数据包丢失；

    (b) 对端收到数据，在返回`ACK`时丢失了；

    `特定时间间隔`: 计算每次发送数据直到收到确认的这段时间，称为 RTT (Round-Trip Time)，在加上一个偏差值，从而计算出超时重传时间。
    因为网络环境的复杂，随时可能发生网络波动，如果单纯的使用 RTT 来计算肯定不够，这就需要有一个偏差来动态调整，如果网络稳定性差，偏差值就大，相反，网络稳定，偏差值也会小。

    &gt; RTT 一般默认初始值为 6 秒。超时时间以 0.5 秒为单位，以 2 的 n 次方倍延长，一旦达到一定次数，会强制断开连接。

    快重传， 是指在发送端连续 3 次收到同一个确认应答，则认为数据包已经丢失，需要进行重发。

#### 流量控制

流量控制是为了防止发送端发送过快，导致网络拥塞或者超过接收方的最大处理能力，接收方丢失数据报触发重传机制，浪费网络流量。方法有：

1. 滑动窗口协议

滑动窗口协议是一种流量控制协议，它允许发送方根据接收方的处理能力，调整发送速率，以提高网络利用率。

发送方维护一个窗口大小，即发送方可以发送的报文段数量，窗口大小由接收方的接收窗口大小确定。

发送方每收到一个确认应答，窗口大小就加 1，直到达到最大报文段长度，则不能再发送。

接收方维护一个接收窗口大小，即接收方可以接收的报文段数量，窗口大小由发送方的窗口大小确定。

接收方每收到一个报文段，窗口大小就减 1，直到窗口大小为 0，则不能再接收。

当窗口大小为 0 时，发送方停止发送报文段，等待接收方的接收窗口大小增加。

2. 滑动窗口的优化

滑动窗口协议存在一个问题，即窗口大小的设置过大，会导致网络拥塞，导致丢包，因此需要对窗口大小进行优化。

优化方法有：

1. 加法增大窗口大小

每收到一个确认应答，窗口大小就加 `1/cwnd`，`cwnd` 是拥塞窗口大小，表示网络的拥塞程度。

`cwnd` 初始值为 1，每收到一个确认应答，`cwnd` 就加 `1`，直到达到最大报文段长度，则不能再发送。

2. 乘法减小窗口大小

每收到一个确认应答，窗口大小就乘 `1/ssthresh`，`ssthresh` 是慢开始阈值，表示网络的拥塞程度。

`ssthresh` 初始值为 65535，每收到一个确认应答，`ssthresh` 就乘 `1/2`，直到收到 3 个重复的确认应答，则认为网络的拥塞程度减小，`cwnd` 就乘 `1/2`，然后重新开始慢开始过程。

#### 拥塞控制

拥塞控制是为了防止过多的数据注入到网络中，导致网络性能下降，甚至发生网络瘫痪。

拥塞控制的目标是控制网络的发送速率，使得网络能够承受现有的网络负荷，而不是使网络过载。

拥塞控制的方法有：

1. 慢开始与拥塞避免

慢开始与拥塞避免是拥塞控制的两个主要方法。

慢开始，是指在开始时，只发送一个报文段，然后指数增长，即每经过一个往返时间 RTT，发送一个报文段的数量就加倍。

拥塞避免，是指当网络拥塞时，减少发送报文段的数量，即每经过一个往返时间 RTT，发送一个报文段的数量就减半。

当网络的拥塞程度达到一定程度时，则进入拥塞避免阶段。

2. 快速重传与快速恢复

快速重传与快速恢复是拥塞控制的两个主要方法。

快速重传，是指在接收到一个失序的报文段后，立即发出重复确认（`ACK`），要求重新发送丢失的报文段。 

快速恢复，是指当发送方连续收到 3 个重复的确认应答时，就执行“乘法减小窗口”的拥塞控制算法。

### TCP 连接建立过程

TCP 连接建立过程分为三步：

1. 客户端发送 `SYN` 报文段，进入 `SYN_SEND` 状态，等待服务器确认；
2. 服务器收到 `SYN` 报文段，发送 `SYN&#43;ACK` 报文段，进入 `SYN_RCVD` 状态，等待客户端确认；
3. 客户端收到 `SYN&#43;ACK` 报文段，发送 `ACK` 报文段，进入 `ESTABLISHED` 状态，连接建立成功。

### TCP 连接释放过程

TCP 连接释放过程分为四步：

1. 客户端或服务器发送 `FIN` 报文段，进入 `FIN_WAIT1` 状态，等待对方确认；
2. 对方收到 `FIN` 报文段，发送 `ACK` 报文段，进入 `CLOSE_WAIT` 状态，等待剩余数据传输完成；
3. 待所有数据传输完成后，发送 `FIN` 报文段，进入 `LAST_ACK` 状态，等待对方确认；
4. 对方收到 `FIN` 报文段，发送 `ACK` 报文段，进入 `CLOSED` 状态，连接释放成功。

### TCP 连接状态

TCP 连接状态有以下几种：

1. `CLOSED` ：初始状态，表示没有任何连接。
2. `LISTEN` ：服务器端的监听状态，表示服务器端正在等待客户端的连接请求。
3. `SYN_SENT` ：客户端发送 `SYN` 报文段，等待服务器确认。
4. `SYN_RCVD` ：服务器端收到 `SYN` 报文段，发送 `SYN&#43;ACK` 报文段，等待客户端确认。
5. `ESTABLISHED` ：连接建立成功。
6. `FIN_WAIT1` ：客户端或服务器端发送 `FIN` 报文段，等待对方确认。
7. `FIN_WAIT2` ：服务器端收到 `FIN` 报文段，发送 `ACK` 报文段，等待剩余数据传输完成。
8. `CLOSE_WAIT` ：客户端收到 `FIN` 报文段，发送 `ACK` 报文段，等待服务器端剩余数据传输完成。
9. `CLOSING` ：客户端或服务器端发送 `FIN` 报文段，等待对方确认。
10. `LAST_ACK` ：服务器端收到 `FIN` 报文段，发送 `ACK` 报文段，等待客户端确认。
11. `TIME_WAIT` ：等待足够的时间，以确保远程 TCP 接收到连接释放的确认。
12. `CLOSED` ：连接关闭。



---

> 作者: 迷途小狼崽  
> URL: http://localhost:1313/posts/network/00_%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/  

